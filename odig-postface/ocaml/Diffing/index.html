<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Diffing (ocaml.Diffing)</title><link rel="stylesheet" href="../../_odoc-theme/odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 2.0.2"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> – <a href="../index.html">ocaml</a> &#x00BB; Diffing</nav><header class="odoc-preamble"><h1>Module <code><span>Diffing</span></code></h1></header><nav class="odoc-toc"><ul><li><a href="#parametric-diffing">Parametric diffing</a><ul><li><a href="#variadic-diffing">Variadic diffing</a></li></ul></li></ul></nav><div class="odoc-content"><h1 id="parametric-diffing"><a href="#parametric-diffing" class="anchor"></a>Parametric diffing</h1><p>This module implements diffing over lists of arbitrary content. It is parameterized by</p><ul><li>The content of the two lists</li><li>The equality witness when an element is kept</li><li>The diffing witness when an element is changed</li></ul><p>Diffing is extended to maintain state depending on the computed changes while walking through the two lists.</p><p>The underlying algorithm is a modified Wagner-Fischer algorithm (see &lt;https://en.wikipedia.org/wiki/Wagner%E2%80%93Fischer_algorithm&gt;).</p><p>We provide the following guarantee: Given two lists <code>l</code> and <code>r</code>, if different patches result in different states, we say that the state diverges.</p><ul><li>We always return the optimal patch on prefixes of <code>l</code> and <code>r</code> on which state does not diverge.</li><li>Otherwise, we return a correct but non-optimal patch where subpatches with no divergent states are optimal for the given initial state.</li></ul><p>More precisely, the optimality of Wagner-Fischer depends on the property that the edit-distance between a k-prefix of the left input and a l-prefix of the right input d(k,l) satisfies</p><p>d(k,l) = min ( del_cost + d(k-1,l), insert_cost + d(k,l-1), change_cost + d(k-1,l-1) )</p><p>Under this hypothesis, it is optimal to choose greedily the state of the minimal patch transforming the left k-prefix into the right l-prefix as a representative of the states of all possible patches transforming the left k-prefix into the right l-prefix.</p><p>If this property is not satisfied, we can still choose greedily a representative state. However, the computed patch is no more guaranteed to be globally optimal. Nevertheless, it is still a correct patch, which is even optimal among all explored patches.</p><div class="odoc-spec"><div class="spec type" id="type-change" class="anchored"><a href="#type-change" class="anchor"></a><code><span><span class="keyword">type</span> <span>('left, 'right, 'eq, 'diff) change</span></span><span> = </span></code><table><tr id="type-change.Delete" class="anchored"><td class="def variant constructor"><a href="#type-change.Delete" class="anchor"></a><code><span>| </span><span><span class="constructor">Delete</span> <span class="keyword">of</span> <span class="type-var">'left</span></span></code></td></tr><tr id="type-change.Insert" class="anchored"><td class="def variant constructor"><a href="#type-change.Insert" class="anchor"></a><code><span>| </span><span><span class="constructor">Insert</span> <span class="keyword">of</span> <span class="type-var">'right</span></span></code></td></tr><tr id="type-change.Keep" class="anchored"><td class="def variant constructor"><a href="#type-change.Keep" class="anchor"></a><code><span>| </span><span><span class="constructor">Keep</span> <span class="keyword">of</span> <span class="type-var">'left</span> * <span class="type-var">'right</span> * <span class="type-var">'eq</span></span></code></td></tr><tr id="type-change.Change" class="anchored"><td class="def variant constructor"><a href="#type-change.Change" class="anchor"></a><code><span>| </span><span><span class="constructor">Change</span> <span class="keyword">of</span> <span class="type-var">'left</span> * <span class="type-var">'right</span> * <span class="type-var">'diff</span></span></code></td></tr></table></div><div class="spec-doc"><p>The type of potential changes on a list.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-map" class="anchored"><a href="#val-map" class="anchor"></a><code><span><span class="keyword">val</span> map : <span><span>(<span><span class="type-var">'l1</span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'l2</span>)</span> <span class="arrow">&#45;&gt;</span></span> <span><span>(<span><span class="type-var">'r1</span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'r2</span>)</span> <span class="arrow">&#45;&gt;</span></span> <span><span><span>(<span class="type-var">'l1</span>, <span class="type-var">'r1</span>, <span class="type-var">'eq</span>, <span class="type-var">'diff</span>)</span> <a href="#type-change">change</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span>(<span class="type-var">'l2</span>, <span class="type-var">'r2</span>, <span class="type-var">'eq</span>, <span class="type-var">'diff</span>)</span> <a href="#type-change">change</a></span></span></code></div></div><div class="odoc-spec"><div class="spec type" id="type-patch" class="anchored"><a href="#type-patch" class="anchor"></a><code><span><span class="keyword">type</span> <span>('l, 'r, 'eq, 'diff) patch</span></span><span> = <span><span><span>(<span class="type-var">'l</span>, <span class="type-var">'r</span>, <span class="type-var">'eq</span>, <span class="type-var">'diff</span>)</span> <a href="#type-change">change</a></span> list</span></span></code></div><div class="spec-doc"><p>A patch is an ordered list of changes.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-diff" class="anchored"><a href="#val-diff" class="anchor"></a><code><span><span class="keyword">val</span> diff : <span>weight:<span>(<span><span><span>(<span class="type-var">'l</span>, <span class="type-var">'r</span>, <span class="type-var">'eq</span>, <span class="type-var">'diff</span>)</span> <a href="#type-change">change</a></span> <span class="arrow">&#45;&gt;</span></span> int)</span> <span class="arrow">&#45;&gt;</span></span>
<span>test:<span>(<span><span class="type-var">'state</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'l</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'r</span> <span class="arrow">&#45;&gt;</span></span> <span><span>(<span class="type-var">'eq</span>, <span class="type-var">'diff</span>)</span> <a href="../Stdlib/index.html#type-result">Stdlib.result</a></span>)</span> <span class="arrow">&#45;&gt;</span></span>
<span>update:<span>(<span><span><span>(<span class="type-var">'l</span>, <span class="type-var">'r</span>, <span class="type-var">'eq</span>, <span class="type-var">'diff</span>)</span> <a href="#type-change">change</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'state</span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'state</span>)</span> <span class="arrow">&#45;&gt;</span></span>
<span><span class="type-var">'state</span> <span class="arrow">&#45;&gt;</span></span> <span><span><span class="type-var">'l</span> array</span> <span class="arrow">&#45;&gt;</span></span> <span><span><span class="type-var">'r</span> array</span> <span class="arrow">&#45;&gt;</span></span> <span><span>(<span class="type-var">'l</span>, <span class="type-var">'r</span>, <span class="type-var">'eq</span>, <span class="type-var">'diff</span>)</span> <a href="#type-patch">patch</a></span></span></code></div><div class="spec-doc"><p><code>diff ~weight ~test ~update state l r</code> computes the diff between <code>l</code> and <code>r</code>, using the initial state <code>state</code>.</p><ul><li><code>test st xl xr</code> tests if the elements <code>xl</code> and <code>xr</code> are compatible (<code>Ok</code>) or not (<code>Error</code>).</li><li><code>weight ch</code> returns the weight of the change <code>ch</code>. Used to find the smallest patch.</li><li><code>update ch st</code> returns the new state after applying a change.</li></ul></div></div><h2 id="variadic-diffing"><a href="#variadic-diffing" class="anchor"></a>Variadic diffing</h2><p>Variadic diffing allows to expand the lists being diffed during diffing.</p><div class="odoc-spec"><div class="spec type" id="type-update" class="anchored"><a href="#type-update" class="anchor"></a><code><span><span class="keyword">type</span> <span>('l, 'r, 'e, 'd, 'state) update</span></span><span> = </span></code><table><tr id="type-update.Without_extensions" class="anchored"><td class="def variant constructor"><a href="#type-update.Without_extensions" class="anchor"></a><code><span>| </span><span><span class="constructor">Without_extensions</span> <span class="keyword">of</span> <span><span><span>(<span class="type-var">'l</span>, <span class="type-var">'r</span>, <span class="type-var">'e</span>, <span class="type-var">'d</span>)</span> <a href="#type-change">change</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'state</span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'state</span></span></code></td></tr><tr id="type-update.With_left_extensions" class="anchored"><td class="def variant constructor"><a href="#type-update.With_left_extensions" class="anchor"></a><code><span>| </span><span><span class="constructor">With_left_extensions</span> <span class="keyword">of</span> <span><span><span>(<span class="type-var">'l</span>, <span class="type-var">'r</span>, <span class="type-var">'e</span>, <span class="type-var">'d</span>)</span> <a href="#type-change">change</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'state</span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'state</span> * <span><span class="type-var">'l</span> array</span></span></code></td></tr><tr id="type-update.With_right_extensions" class="anchored"><td class="def variant constructor"><a href="#type-update.With_right_extensions" class="anchor"></a><code><span>| </span><span><span class="constructor">With_right_extensions</span> <span class="keyword">of</span> <span><span><span>(<span class="type-var">'l</span>, <span class="type-var">'r</span>, <span class="type-var">'e</span>, <span class="type-var">'d</span>)</span> <a href="#type-change">change</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'state</span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'state</span> * <span><span class="type-var">'r</span> array</span></span></code></td></tr></table></div></div><div class="odoc-spec"><div class="spec value" id="val-variadic_diff" class="anchored"><a href="#val-variadic_diff" class="anchor"></a><code><span><span class="keyword">val</span> variadic_diff : <span>weight:<span>(<span><span><span>(<span class="type-var">'l</span>, <span class="type-var">'r</span>, <span class="type-var">'eq</span>, <span class="type-var">'diff</span>)</span> <a href="#type-change">change</a></span> <span class="arrow">&#45;&gt;</span></span> int)</span> <span class="arrow">&#45;&gt;</span></span>
<span>test:<span>(<span><span class="type-var">'state</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'l</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'r</span> <span class="arrow">&#45;&gt;</span></span> <span><span>(<span class="type-var">'eq</span>, <span class="type-var">'diff</span>)</span> <a href="../Stdlib/index.html#type-result">Stdlib.result</a></span>)</span> <span class="arrow">&#45;&gt;</span></span>
<span>update:<span><span>(<span class="type-var">'l</span>, <span class="type-var">'r</span>, <span class="type-var">'eq</span>, <span class="type-var">'diff</span>, <span class="type-var">'state</span>)</span> <a href="#type-update">update</a></span> <span class="arrow">&#45;&gt;</span></span>
<span><span class="type-var">'state</span> <span class="arrow">&#45;&gt;</span></span> <span><span><span class="type-var">'l</span> array</span> <span class="arrow">&#45;&gt;</span></span> <span><span><span class="type-var">'r</span> array</span> <span class="arrow">&#45;&gt;</span></span> <span><span>(<span class="type-var">'l</span>, <span class="type-var">'r</span>, <span class="type-var">'eq</span>, <span class="type-var">'diff</span>)</span> <a href="#type-patch">patch</a></span></span></code></div><div class="spec-doc"><p><code>variadic_diff ~weight ~test ~update state l r</code> behaves as <code>diff</code> with the following difference:</p><ul><li><code>update</code> must now be an <a href="#type-update"><code>update</code></a> which indicates in which direction the expansion takes place.</li></ul></div></div></div></body></html>